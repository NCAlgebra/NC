<< NCPolyInterface`
<< NCPoly`
<< NCPolySOS`

Block[
  {x,y,z,answer,symbol,mom,ver,degree,
   vars, p, poly1, q, SDPVars, chipset,
   p1, p2, p1t, p2t,
   q1, Q1, Q, sol, solQ},

  SetNonCommutative[x,y];

  q[ij__] := Subscript[q, ij];
  z[ij__] := Subscript[z, ij];
    
  (* NCPolySelfAdjointQ *)
  vars = {x,y};
  p = (x+y-x**x);
  poly1 = NCToNCPoly[p**p+A x**y**y**x+B x**x,vars];
  NCTest[NCPolySelfAdjointQ[poly1], True];

  poly1 = NCToNCPoly[x**y,vars];
  NCTest[NCPolySelfAdjointQ[poly1], False];

  poly1 = NCToNCPoly[x**y-y**x,vars];
  NCTest[NCPolySelfAdjointQ[poly1], False];

  poly1 = NCToNCPoly[x**y**x,vars];
  NCTest[NCPolySelfAdjointQ[poly1], True];
  
  poly1 = NCToNCPoly[x + tp[x],{x,tp[x]}];
  NCTest[NCPolySelfAdjointQ[poly1], True];

  poly1 = NCToNCPoly[x**tp[x]-tp[x]**x+x**tp[x]+tp[x]**x,{x,tp[x]}];
  NCTest[NCPolySelfAdjointQ[poly1], True];

  poly1 = NCToNCPoly[x**x,{x,tp[x]}];
  NCTest[NCPolySelfAdjointQ[poly1], False];

  (* Veronese *)
  ver = NCPolyVeronese[2, {1, 1}];
  answer = NCPoly[{1, 1}, <|{0, 0, 0} -> 1, {0, 1, 0} -> 1,
                       {0, 2, 0} -> 1, {1, 0, 1} -> 1, {1, 1, 1} -> 1,
		       {1, 1, 2} -> 1, {2, 0, 3} -> 1|>];
  NCTest[ver, answer];

  ver = NCPolyVeronese[2, {1, 1}];
  answer = NCPoly[{1,1,1,1,1,1,1}, {{},{x},{y},{x,x},{x,y},{y,x},{y,y}}, {x,y}];
  NCTest[ver, answer];

  ver = NCPolyVeronese[3, {1, 1}];
  answer = NCPoly[{1, 1}, <|{0, 0, 0} -> 1, {0, 1, 0} -> 1,
                       {0, 2, 0} -> 1, {0, 3, 0} -> 1, {1, 0, 1} -> 1,
		       {1, 1, 1} -> 1, {1, 1, 2} -> 1, {1, 2, 1} -> 1,
		       {1, 2, 2} -> 1, {1, 2, 4} -> 1, {2, 0, 3} -> 1,
		       {2, 1, 3} -> 1, {2, 1, 5} -> 1, {2, 1, 6} -> 1,
		       {3, 0, 7} -> 1|>];
  NCTest[ver, answer];

  ver = NCPolyVeronese[3, {1, 1}];
  answer = NCPoly[{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
                  {{},{x},{y},{x,x},{x,y},{y,x},{y,y},
		   {x,x,x},{x,y,x},{y,x,x},{y,y,x},
		   {x,x,y},{x,y,y},{y,x,y},{y,y,y}}, {x,y}];
  NCTest[ver, answer];

  ver = NCPolyVeronese[3, {2}];
  answer = NCPoly[{2}, <|{0, 0} -> 1, {1, 0} -> 1,
                       {1, 1} -> 1, {2, 0} -> 1, {2, 1} -> 1,
		       {2, 2} -> 1, {2, 3} -> 1, {3, 0} -> 1,
		       {3, 1} -> 1, {3, 2} -> 1, {3, 3} -> 1,
		       {3, 4} -> 1, {3, 5} -> 1, {3, 6} -> 1,
		       {3, 7} -> 1|>];
  NCTest[ver, answer];

  ver = NCPolyVeronese[2, {1, 2}];
  answer = NCPoly[{1, 2}, <|{0, 0, 0} -> 1, {0, 1, 0} -> 1,
                       {0, 2, 0} -> 1, {1, 0, 1} -> 1, {1, 0, 2} -> 1,
		       {1, 1, 1} -> 1, {1, 1, 2} -> 1, {1, 1, 3} -> 1,
		       {1, 1, 6} -> 1, {2, 0, 4} -> 1, {2, 0, 5} -> 1,
		       {2, 0, 7} -> 1, {2, 0, 8} -> 1|>];
  NCTest[ver, answer];

  ver = NCPolyVeronese[2, {1, 2}, TransposePairs -> {{0, 1}}];
  answer = NCPoly[{1, 2}, <|{0, 0, 0} -> 1, {0, 1, 0} -> 1,
                       {0, 2, 0} -> 1, {1, 0, 1} -> 1, {1, 0, 2} -> 1,
		       {1, 1, 1} -> 1, {1, 1, 2} -> 1, {1, 1, 3} -> 1,
		       {1, 1, 6} -> 1, {2, 0, 4} -> 1, {2, 0, 5} -> 1,
		       {2, 0, 7} -> 1, {2, 0, 8} -> 1|>, TransposePairs -> {{0, 1}}];
  NCTest[ver, answer];

  (* Moment matrix *)
  mom = NCPolyMomentMatrix[2, {1, 1}];
  answer = {{NCPoly[{1, 1}, <|{0, 0, 0} -> 1|>], NCPoly[{1, 1}, <|{0, 1, 0} -> 1|>],
                NCPoly[{1, 1}, <|{1, 0, 1} -> 1|>]},
               {NCPoly[{1, 1}, <|{0, 1, 0} -> 1|>], NCPoly[{1, 1}, <|{0, 2, 0} -> 1|>],
	        NCPoly[{1, 1}, <|{1, 1, 1} -> 1|>]},
	       {NCPoly[{1, 1}, <|{1, 0, 1} -> 1|>], NCPoly[{1, 1}, <|{1, 1, 2} -> 1|>],
	        NCPoly[{1, 1}, <|{2, 0, 3} -> 1|>]}};
  NCTest[mom, answer];

  mom = NCPolyMomentMatrix[4, {1, 1}];
  answer = {{NCPoly[{1, 1}, <|{0, 0, 0} -> 1|>], 
             NCPoly[{1, 1}, <|{0, 1, 0} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 0, 1} -> 1|>], 
             NCPoly[{1, 1}, <|{0, 2, 0} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 1, 2} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 1, 1} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 0, 3} -> 1|>]},
	    {NCPoly[{1, 1}, <|{0, 1, 0} -> 1|>],
	     NCPoly[{1, 1}, <|{0, 2, 0} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 1, 1} -> 1|>], 
             NCPoly[{1, 1}, <|{0, 3, 0} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 2, 2} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 2, 1} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 1, 3} -> 1|>]},
	    {NCPoly[{1, 1}, <|{1, 0, 1} -> 1|>],
	     NCPoly[{1, 1}, <|{1, 1, 2} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 0, 3} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 2, 4} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 1, 6} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 1, 5} -> 1|>], 
             NCPoly[{1, 1}, <|{3, 0, 7} -> 1|>]},
	    {NCPoly[{1, 1}, <|{0, 2, 0} -> 1|>],
	     NCPoly[{1, 1}, <|{0, 3, 0} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 2, 1} -> 1|>], 
             NCPoly[{1, 1}, <|{0, 4, 0} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 3, 2} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 3, 1} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 2, 3} -> 1|>]},
	    {NCPoly[{1, 1}, <|{1, 1, 1} -> 1|>],
	     NCPoly[{1, 1}, <|{1, 2, 2} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 1, 3} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 3, 4} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 2, 6} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 2, 5} -> 1|>], 
             NCPoly[{1, 1}, <|{3, 1, 7} -> 1|>]},
	    {NCPoly[{1, 1}, <|{1, 1, 2} -> 1|>],
	     NCPoly[{1, 1}, <|{1, 2, 4} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 1, 5} -> 1|>], 
             NCPoly[{1, 1}, <|{1, 3, 8} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 2, 10} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 2, 9} -> 1|>], 
             NCPoly[{1, 1}, <|{3, 1, 11} -> 1|>]},
	    {NCPoly[{1, 1}, <|{2, 0, 3} -> 1|>],
	     NCPoly[{1, 1}, <|{2, 1, 6} -> 1|>], 
             NCPoly[{1, 1}, <|{3, 0, 7} -> 1|>], 
             NCPoly[{1, 1}, <|{2, 2, 12} -> 1|>], 
             NCPoly[{1, 1}, <|{3, 1, 14} -> 1|>], 
             NCPoly[{1, 1}, <|{3, 1, 13} -> 1|>], 
             NCPoly[{1, 1}, <|{4, 0, 15} -> 1|>]}};
  NCTest[mom, answer];

  mom = NCPolyMomentMatrix[3, {1, 1}, SelfAdjointPairs -> {{0, 1}}];
  answer = {{NCPoly[{1, 1}, <|{0, 0, 0} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{0, 1, 0} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 0, 1} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{0, 2, 0} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 1, 2} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 1, 1} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 0, 3} -> 1|>, SelfAdjointPairs -> {{0,1}}]},
	    {NCPoly[{1, 1}, <|{0, 1, 0} -> 1|>, SelfAdjointPairs -> {{0,1}}],
	     NCPoly[{1, 1}, <|{0, 2, 0} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 1, 1} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{0, 3, 0} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 2, 2} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 2, 1} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 1, 3} -> 1|>, SelfAdjointPairs -> {{0,1}}]},
	    {NCPoly[{1, 1}, <|{1, 0, 1} -> 1|>, SelfAdjointPairs -> {{0,1}}],
	     NCPoly[{1, 1}, <|{1, 1, 2} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 0, 3} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 2, 4} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 1, 6} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 1, 5} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{3, 0, 7} -> 1|>, SelfAdjointPairs -> {{0,1}}]},
	    {NCPoly[{1, 1}, <|{0, 2, 0} -> 1|>, SelfAdjointPairs -> {{0,1}}],
	     NCPoly[{1, 1}, <|{0, 3, 0} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 2, 1} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{0, 4, 0} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 3, 2} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 3, 1} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 2, 3} -> 1|>, SelfAdjointPairs -> {{0,1}}]},
	    {NCPoly[{1, 1}, <|{1, 1, 1} -> 1|>, SelfAdjointPairs -> {{0,1}}],
	     NCPoly[{1, 1}, <|{1, 2, 2} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 1, 3} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 3, 4} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 2, 6} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 2, 5} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{3, 1, 7} -> 1|>, SelfAdjointPairs -> {{0,1}}]},
	    {NCPoly[{1, 1}, <|{1, 1, 2} -> 1|>, SelfAdjointPairs -> {{0,1}}],
	     NCPoly[{1, 1}, <|{1, 2, 4} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 1, 5} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{1, 3, 8} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 2, 10} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 2, 9} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{3, 1, 11} -> 1|>, SelfAdjointPairs -> {{0,1}}]},
	    {NCPoly[{1, 1}, <|{2, 0, 3} -> 1|>, SelfAdjointPairs -> {{0,1}}],
	     NCPoly[{1, 1}, <|{2, 1, 6} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{3, 0, 7} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{2, 2, 12} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{3, 1, 14} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{3, 1, 13} -> 1|>, SelfAdjointPairs -> {{0,1}}], 
             NCPoly[{1, 1}, <|{4, 0, 15} -> 1|>, SelfAdjointPairs -> {{0,1}}]}};
  NCTest[mom, answer];

  degree = 6;
  ver = NCPolyVeronese[degree, {1, 1}];
  mom = Normal[NCPolyMomentMatrix[ver], SparseArray] - NCPolyMomentMatrix[degree, {1, 1}];
  NCTest[Norm[mom], 0];
		
  (* Test #1 *)

  vars = {x,y};
  p = (x+y-x**x);
  poly1 = NCToNCPoly[p**p+A x**y**y**x+B x**x,vars];

  {q1,Q1,symbol,chipset}=NCPolySOS[poly1];
  NCTest[StringContainsQ[ToString[symbol], "$"], True];
  answer = NCPoly[{1,
  1}, <|{0, 2, 0} -> q[2, 2], {0, 3, 0} ->
   2 q[4, 2], {0, 4, 0} -> q[4, 4], {1, 1, 1} ->
   q[3, 2], {1, 1, 2} -> q[3, 2], {1, 2, 1} ->
   q[4, 3], {1, 2, 2} -> 2 q[5, 2], {1, 2, 4} ->
   q[4, 3], {1, 3, 2} -> q[5, 4], {1, 3, 4} ->
   q[5, 4], {2, 0, 3} -> q[3, 3], {2, 1, 3} ->
   q[5, 3], {2, 1, 6} -> q[5, 3], {2, 2, 6} ->
   q[5, 5]|>] /. q -> symbol;
  NCTest[q1, answer];
  answer = SparseArray[{{2, 2} -> q[2, 2], {2, 3} -> q[3, 2], {2, 4} ->
   q[4, 2], {2, 5} -> q[5, 2], {3, 2} ->
  q[3, 2], {3, 3} -> q[3, 3], {3, 4} ->
  q[4, 3], {3, 5} -> q[5, 3], {4, 2} ->
  q[4, 2], {4, 3} -> q[4, 3], {4, 4} ->
  q[4, 4], {4, 5} -> q[5, 4], {5, 2} ->
  q[5, 2], {5, 3} -> q[5, 3], {5, 4} ->
  q[5, 4], {5, 5} -> q[5, 5], {_, _} -> 0} /. q -> symbol];
  NCTest[Q1, answer];

  {q1,Q1,symbol,chipset}=NCPolySOS[poly1, q];
  NCTest[symbol, q];
  answer = NCPoly[{1, 
  1}, <|{0, 2, 0} -> q[2, 2], {0, 3, 0} -> 
   2 q[4, 2], {0, 4, 0} -> q[4, 4], {1, 1, 1} ->
    q[3, 2], {1, 1, 2} -> q[3, 2], {1, 2, 1} -> 
   q[4, 3], {1, 2, 2} -> 2 q[5, 2], {1, 2, 4} ->
    q[4, 3], {1, 3, 2} -> q[5, 4], {1, 3, 4} -> 
   q[5, 4], {2, 0, 3} -> q[3, 3], {2, 1, 3} -> 
   q[5, 3], {2, 1, 6} -> q[5, 3], {2, 2, 6} -> 
   q[5, 5]|>];
  NCTest[q1, answer];
  answer = SparseArray[{{2, 2} -> q[2, 2], {2, 3} -> q[3, 2], {2, 4} ->
   q[4, 2], {2, 5} -> q[5, 2], {3, 2} -> 
  q[3, 2], {3, 3} -> q[3, 3], {3, 4} -> 
  q[4, 3], {3, 5} -> q[5, 3], {4, 2} -> 
  q[4, 2], {4, 3} -> q[4, 3], {4, 4} -> 
  q[4, 4], {4, 5} -> q[5, 4], {5, 2} -> 
  q[5, 2], {5, 3} -> q[5, 3], {5, 4} -> 
  q[5, 4], {5, 5} -> q[5, 5], {_, _} -> 0}];
  NCTest[Q1, answer];
  
  {Q,SDPVars,sol,solQ}=NCPolySOSToSDP[{poly1-q1},{Q1},z];
  answer = SparseArray[{{1, 1, 1} -> z[2], {1, 1, 2} -> 
    1, {1, 1, 3} -> -1, {1, 2, 1} -> 1, {1, 2, 2} -> 
    1, {1, 2, 3} -> -1, {1, 3, 1} -> -1, {1, 3, 2} -> -1, {1, 3, 3} -> 
    1, {1, 4, 4} -> z[1], {_, _, _} -> 0}];
  NCTest[Q, answer];
  NCTest[SDPVars, {z[1], z[2]}];
  NCTest[sol, {A -> z[1], B -> -1 + z[2]}];
  NCTest[solQ, {q[2, 2] -> z[2], 
   q[3, 2] -> 1, q[3, 3] -> 1, 
   q[4, 2] -> -1, q[4, 3] -> -1, 
   q[4, 4] -> 1, q[5, 2] -> 0, 
   q[5, 3] -> 0, q[5, 4] -> 0, 
   q[5, 5] -> z[1]}];

  (* Test #2 *)

  vars={x,y};
  p=(x+y-x**x)+(x-2y**x)+x**y**x**x;
  pt=tp[p]/.tp->Identity;
  poly1=NCToNCPoly[pt**p,vars];

  {q1,Q1,symbol,chipset}=NCPolySOS[poly1, q];
  NCTest[symbol, q];
  NCTest[q1, NCPoly[{1, 1}, <|{0, 2, 0} -> q[2, 2],
      {0, 3, 0} -> 2 q[4, 2], {0, 4, 0} -> q[4, 4], {1, 1, 1} -> q[3, 2],
      {1, 1, 2} -> q[3, 2], {1, 2, 1} -> q[4, 3], {1, 2, 2} -> 2 q[5, 2],
      {1, 2, 4} -> q[4, 3], {1, 3, 2} -> q[5, 4], {1, 3, 4} -> q[5, 4],
      {1, 4, 4} -> 2 q[18, 2], {1, 5, 4} -> q[18, 4], {1, 5, 8} -> q[18, 4],
      {2, 0, 3} -> q[3, 3], {2, 1, 3} -> q[5, 3], {2, 1, 6} -> q[5, 3],
      {2, 2, 6} -> q[5, 5], {2, 3, 5} -> q[18, 3], {2, 3, 20} -> q[18, 3],
      {2, 4, 10} -> q[18, 5], {2, 4, 20} -> q[18, 5],
      {2, 6, 36} -> q[18, 18]|>]];
  NCTest[Q1, SparseArray[{{2, 2} -> q[2, 2], {2, 3} -> q[3, 2],
      {2, 4} -> q[4, 2], {2, 5} -> q[5, 2], {2, 18} -> q[18, 2],
      {3, 2} -> q[3, 2], {3, 3} -> q[3, 3], {3, 4} -> q[4, 3],
      {3, 5} -> q[5, 3], {3, 18} -> q[18, 3], {4, 2} -> q[4, 2],
      {4, 3} -> q[4, 3], {4, 4} -> q[4, 4], {4, 5} -> q[5, 4],
      {4, 18} -> q[18, 4], {5, 2} -> q[5, 2], {5, 3} -> q[5, 3],
      {5, 4} -> q[5, 4], {5, 5} -> q[5, 5], {5, 18} -> q[18, 5],
      {18, 2} -> q[18, 2], {18, 3} -> q[18, 3], {18, 4} -> q[18, 4],
      {18, 5} -> q[18, 5], {18, 18} -> q[18, 18], {_, _} -> 0}]
  ];

  {Q,SDPVars,sol,solQ}=NCPolySOSToSDP[{poly1-q1},{Q1},z];
  NCTest[Q, SparseArray[{{1, 1, 1} -> 4, {1, 1, 2} -> 2,
      {1, 1, 3} -> -2, {1, 1, 4} -> -4, {1, 1, 5} -> 2, {1, 2, 1} -> 2,
      {1, 2, 2} -> 1, {1, 2, 3} -> -1, {1, 2, 4} -> -2, {1, 2, 5} -> 1,
      {1, 3, 1} -> -2, {1, 3, 2} -> -1, {1, 3, 3} -> 1, {1, 3, 4} -> 2,
      {1, 3, 5} -> -1, {1, 4, 1} -> -4, {1, 4, 2} -> -2, {1, 4, 3} -> 2,
      {1, 4, 4} -> 4, {1, 4, 5} -> -2, {1, 5, 1} -> 2, {1, 5, 2} -> 1,
      {1, 5, 3} -> -1, {1, 5, 4} -> -2, {1, 5, 5} -> 1, {_, _, _} -> 0}]];
  NCTest[SDPVars, {}];
  NCTest[sol, {}];
  NCTest[solQ, {q[2, 2] -> 4, q[3, 2] -> 2, q[3, 3] -> 1, q[4, 2] -> -2,
      q[4, 3] -> -1, q[4, 4] -> 1, q[5, 2] -> -4, q[5, 3] -> -2,
      q[5, 4] -> 2, q[5, 5] -> 4, q[18, 2] -> 2, q[18, 3] -> 1,
      q[18, 4] -> -1, q[18, 5] -> -2, q[18, 18] -> 1}];

  (* Test #3 *)
  
  vars = {x, y};
  p1 = (x + y - x ** x) + (x - 2 y ** x) + x ** y ** x ** x;
  p2 = (x + y - x ** x) ** (x - x ** y + y ** y);
  p1t = tp[p1] /. tp -> Identity;
  p2t = tp[p2] /. tp -> Identity;
  poly1 = NCToNCPoly[p1t ** p1 + p2t ** p2, vars];

  {q1,Q1,symbol,chipset} = NCPolySOS[poly1, q];
  NCTest[symbol, q];
  NCTest[q1, NCPoly[{1, 1}, <|{0, 2, 0} -> q[2, 2], {0, 3, 0} -> 2 q[4, 2],
      {0, 4, 0} -> q[4, 4] + 2 q[8, 2], {0, 5, 0} -> 2 q[8, 4],
      {0, 6, 0} -> q[8, 8], {1, 1, 1} -> q[3, 2], {1, 1, 2} -> q[3, 2],
      {1, 2, 1} -> q[4, 3], {1, 2, 2} -> 2 q[5, 2], {1, 2, 4} -> q[4, 3],
      {1, 3, 1} -> q[8, 3] + q[12, 2], {1, 3, 2} -> q[5, 4],
      {1, 3, 4} -> q[5, 4], {1, 3, 8} -> q[8, 3] + q[12, 2],
      {1, 4, 1} -> q[12, 4] + q[24, 2], {1, 4, 2} -> q[8, 5],
      {1, 4, 4} -> 2 q[18, 2], {1, 4, 8} -> q[8, 5],
      {1, 4, 16} -> q[12, 4] + q[24, 2], {1, 5, 1} -> q[12, 8] + q[24, 4],
      {1, 5, 4} -> q[18, 4], {1, 5, 8} -> q[18, 4], {1, 5, 32} -> q[12, 8] + q[24, 4],
      {1, 6, 1} -> q[24, 8], {1, 6, 4} -> q[18, 8], {1, 6, 16} -> q[18, 8],
      {1, 6, 64} -> q[24, 8], {2, 0, 3} -> q[3, 3], {2, 1, 3} -> q[5, 3],
      {2, 1, 6} -> q[5, 3], {2, 2, 3} -> q[14, 2], {2, 2, 5} -> q[13, 2],
      {2, 2, 6} -> q[5, 5], {2, 2, 9} -> 2 q[12, 3], {2, 2, 10} -> q[13, 2],
      {2, 2, 12} -> q[14, 2], {2, 3, 3} -> q[14, 4] + q[28, 2],
      {2, 3, 5} -> q[13, 4] + q[18, 3], {2, 3, 9} -> q[12, 5],
      {2, 3, 17} -> 2 q[24, 3], {2, 3, 18} -> q[12, 5],
      {2, 3, 20} -> q[13, 4] + q[18, 3], {2, 3, 24} -> q[14, 4] + q[28, 2],
      {2, 4, 3} -> q[14, 8] + q[28, 4], {2, 4, 5} -> q[13, 8],
      {2, 4, 10} -> q[18, 5], {2, 4, 17} -> q[24, 5],
      {2, 4, 20} -> q[18, 5], {2, 4, 33} -> q[12, 12],
      {2, 4, 34} -> q[24, 5], {2, 4, 40} -> q[13, 8],
      {2, 4, 48} -> q[14, 8] + q[28, 4], {2, 5, 3} -> q[28, 8],
      {2, 5, 17} -> q[18, 12], {2, 5, 65} -> 2 q[24, 12], {2, 5, 68} -> q[18, 12],
      {2, 5, 96} -> q[28, 8], {2, 6, 33} -> q[24, 18], {2, 6, 36} -> q[18, 18],
      {2, 6, 129} -> q[24, 24], {2, 6, 132} -> q[24, 18], {3, 1, 7} -> q[15, 2],
      {3, 1, 11} -> q[13, 3] + q[14, 3], {3, 1, 13} -> q[13, 3] + q[14, 3],
      {3, 1, 14} -> q[15, 2], {3, 2, 7} -> q[15, 4], {3, 2, 11} -> q[14, 5],
      {3, 2, 13} -> q[13, 5], {3, 2, 19} -> q[28, 3], {3, 2, 22} -> q[13, 5],
      {3, 2, 25} -> q[28, 3], {3, 2, 26} -> q[14, 5], {3, 2, 28} -> q[15, 4],
      {3, 3, 7} -> q[15, 8], {3, 3, 19} -> q[28, 5], {3, 3, 35} -> q[14, 12],
      {3, 3, 37} -> q[13, 12], {3, 3, 41} -> q[13, 12], {3, 3, 49} -> q[14, 12],
      {3, 3, 50} -> q[28, 5], {3, 3, 56} -> q[15, 8], {3, 4, 19} -> q[18, 14],
      {3, 4, 21} -> q[18, 13], {3, 4, 67} -> q[24, 14] + q[28, 12],
      {3, 4, 69} -> q[24, 13], {3, 4, 81} -> q[24, 13], {3, 4, 84} -> q[18, 13],
      {3, 4, 97} -> q[24, 14] + q[28, 12], {3, 4, 100} -> q[18, 14],
      {3, 5, 35} -> q[28, 18], {3, 5, 131} -> q[28, 24], {3, 5, 193} -> q[28, 24],
      {3, 5, 196} -> q[28, 18], {4, 0, 15} -> 2 q[15, 3], {4, 1, 15} -> q[15, 5],
      {4, 1, 30} -> q[15, 5], {4, 2, 39} -> q[15, 12], {4, 2, 43} -> q[14, 13],
      {4, 2, 45} -> q[13, 13], {4, 2, 51} -> q[14, 14], {4, 2, 53} -> q[14, 13],
      {4, 2, 57} -> q[15, 12], {4, 3, 23} -> q[18, 15], {4, 3, 71} -> q[24, 15],
      {4, 3, 83} -> q[28, 13], {4, 3, 99} -> 2 q[28, 14], {4, 3, 101} -> q[28, 13],
      {4, 3, 113} -> q[24, 15], {4, 3, 116} -> q[18, 15], {4, 4, 195} -> q[28, 28],
      {5, 1, 47} -> q[15, 13], {5, 1, 55} -> q[15, 14], {5, 1, 59} -> q[15, 14],
      {5, 1, 61} -> q[15, 13], {5, 2, 103} -> q[28, 15], {5, 2, 115} -> q[28, 15],
      {6, 0, 63} -> q[15, 15]|>]];

  {Q, SDPVars, sol, solQ} = NCPolySOSToSDP[{poly1 - q1}, {Q1}, z];
  NCTest[Q, SparseArray[{{1, 1, 1} -> 4, {1, 1, 2} -> 2, {1, 1, 3} -> -2,
      {1, 1, 4} -> -4, {1, 1, 5} -> -z[9], {1, 1, 6} -> -z[8],
      {1, 1, 10} -> 2, {1, 1, 11} -> -z[5], {1, 1, 12} -> -z[3],
      {1, 2, 1} -> 2, {1, 2, 2} -> 1, {1, 2, 3} -> -1, {1, 2, 4} -> -2,
      {1, 2, 5} -> z[8], {1, 2, 7} -> z[7], {1, 2, 8} -> -z[7],
      {1, 2, 10} -> -z[6], {1, 3, 1} -> -2, {1, 3, 2} -> -1,
      {1, 3, 3} -> 2 + 2 z[9], {1, 3, 4} -> 3, {1, 3, 5} -> -1,
      {1, 3, 6} -> -1 + z[5], {1, 3, 7} -> z[6], {1, 3, 8} -> 1 + z[3],
      {1, 3, 9} -> 1, {1, 3, 10} -> -1, {1, 3, 11} -> -z[4],
      {1, 3, 12} -> -z[2], {1, 4, 1} -> -4, {1, 4, 2} -> -2, {1, 4, 3} -> 3,
      {1, 4, 4} -> 5, {1, 4, 5} -> -1, {1, 4, 6} -> -1, {1, 4, 7} -> -1,
      {1, 4, 8} -> 1, {1, 4, 9} -> 1, {1, 4, 10} -> -2, {1, 4, 11} -> 1,
      {1, 4, 12} -> -1, {1, 5, 1} -> -z[9], {1, 5, 2} -> z[8], {1, 5, 3} -> -1,
      {1, 5, 4} -> -1, {1, 5, 5} -> 1, {1, 5, 6} -> 2 + z[4], {1, 5, 7} -> 1,
      {1, 5, 8} -> -2 + z[2], {1, 5, 9} -> -1, {1, 5, 11} -> -1,
      {1, 5, 12} -> 1, {1, 6, 1} -> -z[8], {1, 6, 3} -> -1 + z[5],
      {1, 6, 4} -> -1, {1, 6, 5} -> 2 + z[4], {1, 6, 6} -> 1, {1, 6, 7} -> 1,
      {1, 6, 8} -> -1, {1, 6, 9} -> -1, {1, 6, 11} -> -1, {1, 6, 12} -> -z[1],
      {1, 7, 2} -> z[7], {1, 7, 3} -> z[6], {1, 7, 4} -> -1, {1, 7, 5} -> 1,
      {1, 7, 6} -> 1, {1, 7, 7} -> 1, {1, 7, 8} -> -1, {1, 7, 9} -> -1,
      {1, 7, 11} -> -1, {1, 7, 12} -> 1, {1, 8, 2} -> -z[7], {1, 8, 3} -> 1 + z[3],
      {1, 8, 4} -> 1, {1, 8, 5} -> -2 + z[2], {1, 8, 6} -> -1, {1, 8, 7} -> -1,
      {1, 8, 8} -> 1, {1, 8, 9} -> 1, {1, 8, 11} -> 2 + z[1], {1, 8, 12} -> -1,
      {1, 9, 3} -> 1, {1, 9, 4} -> 1, {1, 9, 5} -> -1, {1, 9, 6} -> -1,
      {1, 9, 7} -> -1, {1, 9, 8} -> 1, {1, 9, 9} -> 1, {1, 9, 11} -> 1,
      {1, 9, 12} -> -1, {1, 10, 1} -> 2, {1, 10, 2} -> -z[6], {1, 10, 3} -> -1,
      {1, 10, 4} -> -2, {1, 10, 10} -> 1, {1, 11, 1} -> -z[5], {1, 11, 3} -> -z[4],
      {1, 11, 4} -> 1, {1, 11, 5} -> -1, {1, 11, 6} -> -1, {1, 11, 7} -> -1,
      {1, 11, 8} -> 2 + z[1], {1, 11, 9} -> 1, {1, 11, 11} -> 1, {1, 11, 12} -> -1,
      {1, 12, 1} -> -z[3], {1, 12, 3} -> -z[2], {1, 12, 4} -> -1, {1, 12, 5} -> 1,
      {1, 12, 6} -> -z[1], {1, 12, 7} -> 1, {1, 12, 8} -> -1, {1, 12, 9} -> -1,
      {1, 12, 11} -> -1, {1, 12, 12} -> 1, {_, _, _} -> 0}]];
  NCTest[SDPVars, {z[1], z[2], z[3], z[4], z[5], z[6], z[7], z[8], z[9]}];
  NCTest[sol, {}];
  NCTest[solQ, {q[2, 2] -> 4, q[3, 2] -> 2, q[3, 3] -> 1, q[4, 2] -> -2,
      q[4, 3] -> -1, q[4, 4] -> 2 + 2 z[9], q[5, 2] -> -4, q[5, 3] -> -2,
      q[5, 4] -> 3, q[5, 5] -> 5, q[8, 2] -> -z[9], q[8, 3] -> z[8], q[8, 4] -> -1,
      q[8, 5] -> -1, q[8, 8] -> 1, q[12, 2] -> -z[8], q[12, 3] -> 0,
      q[12, 4] -> -1 + z[5], q[12, 5] -> -1, q[12, 8] -> 2 + z[4],
      q[12, 12] -> 1, q[13, 2] -> 0, q[13, 3] -> z[7], q[13, 4] -> z[6],
      q[13, 5] -> -1, q[13, 8] -> 1, q[13, 12] -> 1, q[13, 13] -> 1,
      q[14, 2] -> 0, q[14, 3] -> -z[7], q[14, 4] -> 1 + z[3], q[14, 5] -> 1,
      q[14, 8] -> -2 + z[2], q[14, 12] -> -1, q[14, 13] -> -1, q[14, 14] -> 1,
      q[15, 2] -> 0, q[15, 3] -> 0, q[15, 4] -> 1, q[15, 5] -> 1, q[15, 8] -> -1, 
      q[15, 12] -> -1, q[15, 13] -> -1, q[15, 14] -> 1, q[15, 15] -> 1, 
      q[18, 2] -> 2, q[18, 3] -> -z[6], q[18, 4] -> -1, q[18, 5] -> -2, 
      q[18, 8] -> 0, q[18, 12] -> 0, q[18, 13] -> 0, q[18, 14] -> 0, 
      q[18, 15] -> 0, q[18, 18] -> 1, q[24, 2] -> -z[5], q[24, 3] -> 0, 
      q[24, 4] -> -z[4], q[24, 5] -> 1, q[24, 8] -> -1, q[24, 12] -> -1, 
      q[24, 13] -> -1, q[24, 14] -> 2 + z[1], 
      q[24, 15] -> 1, q[24, 18] -> 0, q[24, 24] -> 1, q[28, 2] -> -z[3], 
      q[28, 3] -> 0, q[28, 4] -> -z[2], q[28, 5] -> -1, q[28, 8] -> 1, 
      q[28, 12] -> -z[1], q[28, 13] -> 1, q[28, 14] -> -1, q[28, 15] -> -1, 
      q[28, 18] -> 0, q[28, 24] -> -1, q[28, 28] -> 1}];

];
